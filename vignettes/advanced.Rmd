---
title: "Advanced examples"
abstract: >
  This vignette assumes you are familiar with set operations from the basic vignette.
date: "`r BiocStyle::doc_date()`"
package: "`r BiocStyle::pkg_ver('BaseSet')`"
output:
  BiocStyle::html_document:
    fig_caption: true
    code_folding: show
    self_contained: yes
    toc_float:
      collapsed: true
      toc_depth: 3
author:
- name: LluÃ­s Revilla
  affiliation: 
    - August Pi i Sunyer Biomedical Research Institute (IDIBAPS); Liver Unit, Hospital Clinic
  email: lluis.revilla@gmail.com
vignette: >
  %\VignetteIndexEntry{2. Advanced examples}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, 
                      warning = TRUE,
                      comment = "#>")
```
To show compatibility with tidy workflows we will use magrittr pipe operator
```{r setupr}
library("dplyr")
library("BaseSet")
```
We can create a tidySet with some sets being the intersection and the union of others:
```{r}
relations <- data.frame(sets = c(rep("A", 5), "B"),
                        elements = letters[seq_len(6)],
                        fuzzy = runif(6))
sample_set <- tidySet(relations) %>% 
  union(c("A", "B"), "C", keep = TRUE) %>% 
  intersection(c("B", "C"), "D", keep = TRUE)

# Number of elements per set
sample_set %>% 
  relations() %>% 
  group_by(sets) %>% 
  count()

# size of the sets and probability
sample_set %>% 
  set_size()
```

# Human GO

We will explore the genes related with GO. 

```{r prepare_GO}
# We load some libraries
library("org.Hs.eg.db")
library("GO.db")
library("ggplot2")

# Prepare the data 
h2GO_TS <- tidySet(org.Hs.egGO)
h2GO <- as.data.frame(org.Hs.egGO)
```
We can now explore if there are differences in evidence usage for each ontology in GO:
```{r evidence_ontology}
library("forcats")
h2GO %>% 
    group_by(Evidence, Ontology) %>% 
    count(name = "Freq") %>% 
    ungroup() %>% 
    mutate(Evidence = fct_reorder2(Evidence, Ontology, -Freq)) %>% 
    ggplot() +
    geom_col(aes(Evidence, Freq)) +
    facet_grid(~Ontology) + 
    theme_bw() +
    coord_flip() +
    xlab("Evidence")
```
We can see that 
This graph doesn't consider that some relationships are better annotated than other:
```{r nEvidence_plot}
h2GO_TS %>% 
  relations() %>% 
  ggplot() +
    geom_histogram(aes(nEvidence), binwidth = 1) +
    theme_minimal() +
    # scale_y_log10() +
    labs(x = "Evidence codes", 
         title = "Evidence codes for each relation between GO and a gene",
         subtitle = "in human annotation")
```
We can see that mostly all the annotations are done with a single evidence code.
So far we have explored the code that it is related to a gene but how many genes don't have any annotation?
```{r numbers}
# Add all the genes and GO terms
library("GO.db")
h2GO_TS <- add_elements(h2GO_TS, keys(org.Hs.eg.db)) %>% 
  add_sets(grep("^GO:", keys(GO.db), value = TRUE))

sizes_element <- element_size(h2GO_TS) %>% 
    arrange(desc(size))
sum(sizes_element$size == 0)
sum(sizes_element$size != 0)

sizes_set <- set_size(h2GO_TS) %>% 
    arrange(desc(size))
sum(sizes_set$size == 0)
sum(sizes_set$size != 0)
```
So we can see that both there are more genes without annotation and more GO terms without a (direct) gene annotated.

```{r plots_GO}
sizes_element %>% 
    filter(size != 0) %>% 
    ggplot() +
    geom_histogram(aes(size), binwidth = 1) +
    theme_minimal() +
    labs(x = "# sets per element", y = "Count")

sizes_set %>% 
    filter(size != 0) %>% 
    ggplot() +
    geom_histogram(aes(size), binwidth = 1) +
    theme_minimal() +
    labs(x = "# elements per set", y = "Count")
```
As you can see on the second plot we have very large values but that are on associated on many genes:
```{r distr_sizes}
head(sizes_set, 10)
```

# Human pathways

Now we will repeat the same analysis with pathways:

```{r prepare_reactome}
# We load some libraries
library("reactome.db")

# Prepare the data (is easier, there isn't any ontoogy or evidence column)
h2p <- as.data.frame(reactomeEXTID2PATHID)
colnames(h2p) <- c("sets", "elements")
# Filter only for human pathways
h2p <- h2p[grepl("^R-HSA-", h2p$sets), ]

# There are duplicate relations with different evidence codes!!: 
summary(duplicated(h2p[, c("elements", "sets")]))
h2p <- unique(h2p)
# Create a tidySet and 
h2p_TS <- tidySet(h2p) %>% 
    # Add all the genes 
    add_elements(keys(org.Hs.eg.db))
```
Now that we have everything ready we can start measuring some things..
```{r numbers_pathways}
sizes_element <- element_size(h2p_TS) %>% 
    arrange(desc(size))
sum(sizes_element$size == 0)
sum(sizes_element$size != 0)

sizes_set <- set_size(h2p_TS) %>% 
    arrange(desc(size))
```
We can see there are more genes without pathways than genes with pathways.

```{r pathways_plots}
sizes_element %>% 
    filter(size != 0) %>% 
    ggplot() +
    geom_histogram(aes(size), binwidth = 1) +
    scale_y_log10() +
    theme_minimal() +
    labs(x = "# sets per element", y = "Count")

sizes_set %>% 
    ggplot() +
    geom_histogram(aes(size), binwidth = 1) +
    scale_y_log10() +
    theme_minimal() +
    labs(x = "# elements per set", y = "Count")
```
As you can see on the second plot we have very large values but that are on associated on many genes:
```{r distr_sizes_pathways}
head(sizes_set, 10)
```

# Bioconductor packages

We can quickly access the dependencies and maintainers of Bioconductor' packages:

```{r}
views <- "https://bioconductor.org/packages/devel/bioc/VIEWS"
dcf <- read.dcf(url(views), c("Package", "Maintainer", "dependencyCount", 
                  "Depends", "Imports"))
tbl <- as_tibble(dcf) %>%
   mutate(
     Maintainer = gsub("[[:space:]]+", " ", Maintainer),
     dependencyCount = as.integer(dependencyCount),
     Core = grepl("Bioconductor Package Maintainer", Maintainer),
     Maintainer = stringr::str_split(Maintainer, ",?\\s*|( and )"),
     Depend = stringr::str_split(Depends, ",?\\s+"), 
     Import = stringr::str_split(Imports, ",?\\s+"),
     )
  
```

## Maintainers
Now we have several sets each package with the dependencies and each package and the maintainers. We must tidy them:
```{r}
l <- tbl[, "Maintainer", drop = TRUE]
names(l) <- tbl[, "Package", drop = TRUE]
maintainers <- tidySet(l)
is_nested(maintainers)
```
Now we are ready for some plots:
```{r}
maintainers %>% 
  set_size() %>% 
  arrange(-size) %>% 
  select(-probability) %>%
  ggplot() +
  geom_histogram(aes(size)) + 
  scale_y_log10() +
  theme_minimal() +
  labs(title = "Maintainers by package")
maintainers %>% 
  filter_element(!grepl("Bioconductor Package Maintainer", as.character(elements))) %>% 
  element_size() %>% 
  arrange(-size) %>% 
  select(-probability) %>%
  ggplot() +
  geom_histogram(aes(size)) + 
  scale_y_log10() +
  theme_minimal() +
  labs(title = "Packages maintained by person")
```


Although some people might have more packages (but so far only 86 ORCIDs are found)
```{r}
grep("Carey", elements(maintainers)$elements, value = TRUE)
```

```{r}
Bioconductor_packages <- maintainers %>% 
  filter_element(grepl("Bioconductor Package Maintainer", 
                       elements)) %>% 
  droplevels() %>% 
  name_sets()
Bioconductor_packages
```


## Dependencies

Now let's work on them
```{r}
l <- apply(tbl[, c("Depend", "Import")], 1, function(x){
  y <- unlist(x, use.names = FALSE)
  y <- gsub(" ?\\(.*", "", y)
  y <- y[!grepl("\\)", y)]
  y <- y[y != ""]
  unique(y[!is.na(y)])
})
names(l) <- tbl[, "Package", drop = TRUE]
packages <- tidySet(l) %>% 
  filter_element(elements != "R") %>% 
  mutate_element(Origin = case_when(
    elements  %in% c("methods", "stats", "utils", "graphics", "grDevices") ~ "R core",
    elements  %in% Bioconductor_packages ~ "Bioconductor Core",
    elements  %in% name_sets(packages) ~  "Bioconductor",
    TRUE ~ "CRAN"))
is_nested(packages)
```

```{r}
packages %>% 
  set_size() %>% 
  arrange(-size) %>% 
  select(-probability) %>%
  ggplot() +
  geom_histogram(aes(size), bins = 50) +
  scale_y_log10() +
  theme_minimal() +
  labs(title = "Packages dependencies")
p <- packages %>% 
  element_size() %>% 
  arrange(-size) %>% 
  select(-probability) %>% 
  left_join(elements(packages), by = c("element" = "elements"))
p %>% 
  ggplot() +
  geom_histogram(aes(size)) + 
  scale_y_log10() +
  theme_minimal() +
  labs(title = "Packages depended")
p %>% 
  ggplot(aes(Origin, size)) +
  geom_violin() +
  geom_point(position = position_jitter()) +
  theme_minimal() +
  scale_y_log10()
table(p$Origin)
```

# Historic dowload data

We can use the download stats to further enrich our data

# Session info {.unnumbered}

```{r sessionInfo, echo=FALSE}
sessionInfo()
```
